name: CI

on:
  push:
    branches: ["*"]
  pull_request:

jobs:
  lint-build-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: Select Xcode 26.1.1 (if present) or fallback to default
        run: |
          set -euo pipefail
          for candidate in /Applications/Xcode_26.1.1.app /Applications/Xcode_26.1.app /Applications/Xcode.app; do
            if [[ -d "$candidate" ]]; then
              sudo xcode-select -s "$candidate"
              echo "DEVELOPER_DIR=${candidate}/Contents/Developer" >> "$GITHUB_ENV"
              break
            fi
          done
          /usr/bin/xcodebuild -version

      - name: Install Swift 6.2 toolchain
        run: |
          curl -L https://download.swift.org/swift-6.2-release/xcode/swift-6.2-RELEASE/swift-6.2-RELEASE-osx.pkg -o /tmp/swift.pkg
          sudo installer -pkg /tmp/swift.pkg -target /
          echo "/Library/Developer/Toolchains/swift-6.2-RELEASE.xctoolchain/usr/bin" >> "$GITHUB_PATH"
          echo "TOOLCHAINS=swift-6.2-RELEASE" >> "$GITHUB_ENV"

      - name: Install lint tools
        run: brew install swiftlint swiftformat

      - name: SwiftFormat (lint)
        run: swiftformat Sources Tests --lint

      - name: SwiftLint
        run: swiftlint --strict

      - name: Swift Test
        run: swift test --parallel

  build-linux-cli:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            runs-on: ubuntu-24.04
          - name: linux-arm64
            runs-on: ubuntu-24.04-arm
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v6

      - name: Runner info
        run: |
          set -euo pipefail
          uname -a
          uname -m

      - name: Install SQLite3
        run: sudo apt-get update && sudo apt-get install -y libsqlite3-dev

      - name: Setup Swift 6.2.1
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2.1"
          skip-verify-signature: true

      - name: Build CodexBarCLI (release, static Swift stdlib)
        run: swift build -c release --product CodexBarCLI --static-swift-stdlib

      - name: Swift Test (Linux only)
        run: swift test --parallel

      - name: Smoke test CodexBarCLI
        shell: bash
        run: |
          set -euo pipefail
          BIN_DIR="$(swift build -c release --product CodexBarCLI --static-swift-stdlib --show-bin-path)"
          BIN="$BIN_DIR/CodexBarCLI"
          "$BIN" --help >/dev/null
          "$BIN" --version >/dev/null
          if "$BIN" usage --provider codex --web >/dev/null 2>&1; then
            echo "Expected --web to fail on Linux"
            exit 1
          fi
          "$BIN" usage --provider codex --web 2>&1 | tee /tmp/codexbarcli-stderr.txt >/dev/null || true
          grep -q "macOS" /tmp/codexbarcli-stderr.txt
